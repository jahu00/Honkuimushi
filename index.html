<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<script type="text/javascript" src="jquery-1.8.2.min.js"></script>
		<script type="text/javascript" src="toKana.js"></script>
		<script type="text/javascript" src="js/fileHelpers.js"></script>
		<script type="text/javascript" src="js/preloadStyleImages.js"></script>
		<script type="text/javascript" src="rikaikun/data.js"></script>
		<link type="text/css" rel="stylesheet" media="screen" href="style.css">
	</head>
	<body>
		<div class="templates" style="display:none">
			<div class="tile unselectable">
				<svg width="100%" height="100%" viewBox="0 0 13 15">
					<text x="50%" y="13" text-anchor="middle"></text>
				</svg>
			</div>
			<div class="column odd"><div class="spacer"></div></div>
			<div class="column even"></div>
			<div class="arrow"></div>
		</div>
		<div class="game">
			<div class="sidebar">
				<div class="word-container">
					<div class="word"></div>
					<div class="points"></div>
					<!--<svg width="100%" height="100%" viewBox="0 0 30 15">
						<text x="50%" y="13" textLength="100%" lengthAdjust="spacingAndGlyphs" text-anchor="middle"></text>
					</svg>-->
				</div>
				<div class="dictionary">
				</div>
			</div>
			<div class="board">
			</div>
		</div>
		<script>
			var rikaikun = new rcxDict(false);
		
			var letters = [
				{letter:'a', probability: 0.138968333, points: 1},
				{letter:'o', probability: 0.108195018, points: 1},
				{letter:'i', probability: 0.104272961, points: 1},
				{letter:'u', probability: 0.087630851, points: 2},
				{letter:'n', probability: 0.085601805, points: 2},
				{letter:'e', probability: 0.068102514, points: 3},
				{letter:'k', probability: 0.065016332, points: 3},
				{letter:'t', probability: 0.058419475, points: 3},
				{letter:'s', probability: 0.057478706, points: 3},
				{letter:'r', probability: 0.049367439, points: 4},
				{letter:'h', probability: 0.047018794, points: 4},
				{letter:'m', probability: 0.028580373, points: 5},
				{letter:'d', probability: 0.026679167, points: 5},
				{letter:'g', probability: 0.022093326, points: 5},
				{letter:'y', probability: 0.0151277, points: 6},
				{letter:'j', probability: 0.008953697, points: 7},
				{letter:'c', probability: 0.008094877, points: 7},
				{letter:'b', probability: 0.008080126, points: 7},
				{letter:'w', probability: 0.004420304, points: 8},
				{letter:'z', probability: 0.00441047, points: 8},
				{letter:'f', probability: 0.002348645, points: 9},
				{letter:'p', probability: 0.001139085, points: 10}
			];
			
			var constants = {
				width: 7,
				height: 7
			}
			
			var word = [];
			var dictionaryEntries = null;
			var score = 0;
			var level = 1;
			
			function lastLetter()
			{
				return word[word.length - 1];
			}			
			
			var isValidWord = false;
			
			function randomLetter()
			{
				var rand = Math.random();
				var base = 0;
				var letter = null;
				for (var i = 0, _letters = letters; i < _letters.length; i++)
				{
					letter = _letters[i];
					base += letter.probability;
					if (rand < base)
					{
						break;
					}
				}
				return letter;
			}
			
			$(function()
			{
				var tileTemplate = $('.templates .tile');
				var oddColumnTemplate = $('.templates .column.odd');
				var evenColumnTemplate = $('.templates .column.even');
				var arrowTemplate = $('.templates .arrow');
				
				var board = $('.board');
				
				for(var n = 1; n < (constants.width + 1); n++)
				{
					var newColumn = null;
					if(n % 2 == 1)
					{
						newColumn = oddColumnTemplate.clone();
					}
					else
					{
						newColumn = evenColumnTemplate.clone();
					}
					
					newColumn.attr('data-column', n);
					board.append(newColumn);
				}
				
				function updateColumns()
				{
					$('.column').each(function()
					{
						var column = $(this);
						var columnId = column.attr('data-column');
						var tileCount = column.find('.tile').length;
						
						var targetCount = constants.height;
						if (column.hasClass('even'))
						{
							targetCount++;
						}
						for(var i = 0; i < targetCount - tileCount; i++)
						{
							var newTile = tileTemplate.clone();
							var letter = randomLetter();
							newTile.attr('data-letter', letter.letter);
							newTile.attr('data-points', letter.points);
							newTile.find('svg text').html(letter.letter.toUpperCase());
							column.prepend(newTile);
						}
						
						tileCount = 0;
						column.find('.tile').each(function()
						{
							var tile = $(this);
							tile.attr('data-row', tileCount);
							tile.attr('data-column', columnId);
							tileCount++;
						});
					});
				}
				
				function fillDictionary(entries)
				{
					$('.sidebar .dictionary').html("");
					for (var i = 0; i < entries.length; i++)
					{
						var entry = entries[i];
						$('.sidebar .dictionary').append('<div class="item">' + entry[0] + (entry[1] != null ? '<br/>' + entry[1] : '') + '</div>');
					}
				}
				
				function checkDictionary(letters, word, kana)
				{
					isValidWord = false;
					dictionaryEntries = null;
					updatePoints("");
					if (word.length > 2 && !(/[a-z]/i).test(kana))
					{
						var search = rikaikun.wordSearch(kana, false, 15);
						if (search != null && search.data.length > 0)
						{
							isValidWord = true;
							dictionaryEntries = search.data;
						}
					}
					if (isValidWord)
					{
						$(lastLetter()).addClass('valid');
						var points = 0;
						for(var i = 0; i < letters.length; i++)
						{
							var letter = $(letters[i]);
							points += parseInt(letter.attr('data-points'));
						}
						points += level;
						points = points * 10 * word.length;
						updatePoints(points);
					}
				}
				
				function updateWord()
				{
					var value = "";
					var _word = word;
					for(var i = 0; i < word.length; i++)
					{
						var letter = $(word[i]);
						value += letter.attr('data-letter');
					}
					var kana = ToKana.fromRomaji(value);
					//$('.sidebar .word svg text').html(kana);
					$('.sidebar .word-container .word').html(kana);
					checkDictionary(_word, value, kana);
				}
				
				function updatePoints(points)
				{
					$('.sidebar .word-container .points').text(points);
				}
				
				function removeArrow(letter)
				{
					$(letter).find('.arrow').remove();
				}
				
				function deselect(word)
				{
					for(var i = 0; i < word.length; i++)
					{
						var letter = word[i];
						$(letter).removeClass('selected');
						$(letter).removeClass('valid');
						removeArrow(letter);
					}
				}
				
				function confirm()
				{
					fillDictionary(dictionaryEntries);
					var _word = word;
					for(var i = 0; i < _word.length; i++)
					{
						$(_word[i]).remove();
					}
					_word.splice(0, _word.length);
					updateColumns();
				}
				
				$('.board').on('click', '.tile', function()
				{
					var self = this;
					var tile = $(this);
					var _lastLetter = $(lastLetter());
					var _word = word;
					if (tile.hasClass('selected'))
					{
						if (self == _lastLetter[0])
						{
							if (isValidWord)
							{
								confirm();
							}
							else
							{
								//tile.removeClass('selected');
								deselect(_word.splice(_word.length - 1, 1));
							}
						}
						else
						{
							var index = $.inArray(self, _word) + 1;
							deselect(_word.splice(index, _word.length - index));
						}
						if (_word.length > 0)
						{
							removeArrow(lastLetter());
						}
					}
					else
					{
						if(typeof _lastLetter != "undefined")
						{
							var lastColumn = parseInt(_lastLetter.attr('data-column'));
							var lastRow = parseInt(_lastLetter.attr('data-row'));
							var currentColumn = parseInt(tile.attr('data-column'));
							var currentRow = parseInt(tile.attr('data-row'));
							if
							(
								Math.abs(currentColumn - lastColumn) > 1
								||
								(
									Math.abs(currentColumn - lastColumn) == 1
									&&
									(
										currentColumn % 2 == 1
										&& 
										(
											currentRow > lastRow
											|| currentRow - lastRow < -1
										)
										||
										currentColumn % 2 == 0
										&& 
										(
											currentRow < lastRow
											|| currentRow - lastRow > 1
										)
									)
								)
								||
								(
									currentColumn == lastColumn
									&& Math.abs(currentRow - lastRow) != 1
								)
							)
							{
								deselect(_word.splice(0, _word.length));
							}
						}
						if (_word.length > 0)
						{
							var arrowClass = ""
							_lastLetter = $(lastLetter());
							var lastLetterOffset = _lastLetter.offset();
							var tileOffset = tile.offset();
							if (tileOffset.top > lastLetterOffset.top)
							{
								arrowClass = "down";
							}
							else
							{
								arrowClass = "up";
							}
							if (tileOffset.left > lastLetterOffset.left)
							{
								arrowClass += "-right"
							}
							else if (tileOffset.left < lastLetterOffset.left)
							{
								arrowClass += "-left"
							}
							var newArrow = arrowTemplate.clone();
							newArrow.addClass(arrowClass);
							_lastLetter.append(newArrow);
						}
						_word.push(self);
						tile.addClass('selected');
					}
					updateWord();
				});
				
				function init()
				{
					preloadStyleImages.preload();
					updateColumns();
				}
				
				init();
			});
		</script>
	</body>
</html>