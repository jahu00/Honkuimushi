<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<meta name="format-detection" content="telephone=no" />
        <meta name="msapplication-tap-highlight" content="no" />
        <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
		<script type="text/javascript" src="jquery-1.8.2.min.js"></script>
		<script type="text/javascript" src="constants.js"></script>
		<script type="text/javascript" src="letters.js"></script>
		<script type="text/javascript" src="js/fileHelpers.js"></script>
		<script type="text/javascript" src="js/preloadStyleImages.js"></script>
		<script type="text/javascript" src="js/fastclick/fastclick.js"></script>
		<script type="text/javascript" src="toKana.js"></script>
		<script type="text/javascript" src="rikaikun/data.js"></script>
		<script type="text/javascript" src="wordFrequency.js"></script>
		<script type="text/javascript" src="menu.js"></script>
		<script type="text/javascript" src="app.js"></script>
		<link type="text/css" rel="stylesheet" media="screen" href="style.css">
		<link type="text/css" rel="stylesheet" media="screen" href="fonts/montserrat/montserrat.css">
		<link type="text/css" rel="stylesheet" media="screen" href="fonts/bokutachi-no-gothic-2/bokutachi-no-gothic-2.css">
		<link type="text/css" rel="stylesheet" media="screen" href="fonts/honoka-antique-maru/honoka-antique-maru.css">
		<link type="text/css" rel="stylesheet" media="screen" href="fonts/sigmar-one/sigmar-one.css">
	</head>
	<body class="unselectable">
		<div class="templates" style="display:none">
			<div class="tile">
				<div class="overlay"></div>
				<div class="letter"></div>
				<div class="point-indicator"></div>
			</div>
			<div class="column odd"><div class="spacer"></div></div>
			<div class="column even"></div>
			<div class="arrow"></div>
		</div>
		<div class="gray-out"></div>
		<div id="Container" class="gpu">
			<div class="gray-out"></div>
			<div class="popup">
				<div class="header">
					<span class="on-game-over">Game Over</span>
					<span class="on-level-up">Level up!</span>
				</div>
				<div class="actions outline">
					<div class="button on-level-up continue">Continue</div>
					<div class="button on-game-over menu">Menu</div>
				</div>
			</div>
			<div class="loading screen">
				<div class="progress">
				<div class="bar"></div>
				</div>
			</div>
			<div class="menu screen">
				<div class="logo"></div>
				<div class="buttons">
					<div class="button resume-game" style="display:none">Resume game</div>
					<div class="button new-game">New game</div>
					<!--<div class="button options">Options</div>-->
					<!--<div class="button hall-of-fame">Hall of fame</div>-->
					<!--<div class="button exit">Exit</div>-->
				</div>
			</div>
			<div class="game screen">
				<div class="sidebar">
					<div class="score outline">0</div>
					<div class="word-container">
						<div class="word"></div>
						<div class="points"></div>
						<div class="level-indicator">Level <span class="level">1</span></div>
					</div>
					<div class="button outline submit">Submit</div>
					<div class="progress"><div class="bar"></div></div>
					<div class="button outline shuffle">Shuffle</div>
					<div class="dictionary">
					</div>
					<div class="button outline menu">Menu</div>
				</div>
				<div class="board">
				</div>
			</div>
		</div>
		<script>
			/*var rikaikun = null; //new rcxDict(false);
			var wordFrequency = null; //new WordFrequency();*/
			
			var word = [];
			var dictionaryEntries = null;
			var score = 0;
			var points = 0;
			var level = 1;
			var nextLevel = 3000;
			var lastLevel = 0;
			var flameChance = 0;
			function lastLetter()
			{
				return word[word.length - 1];
			}			
			
			var isValidWord = false;
			
			function randomLetter()
			{
				var rand = Math.random();
				var base = 0;
				var letter = null;
				for (var i = 0, _letters = letters; i < _letters.length; i++)
				{
					letter = _letters[i];
					base += letter.probability;
					if (rand < base)
					{
						break;
					}
				}
				return letter;
			}
			
			$(function()
			{
				//var app = new App();
				window.app = new App();
			
				var tileTemplate = $('.templates .tile');
				var oddColumnTemplate = $('.templates .column.odd');
				var evenColumnTemplate = $('.templates .column.even');
				var arrowTemplate = $('.templates .arrow');
				
				function createColumns()
				{
					var board = $('.board');
					var spacerType = 1;
					for(var n = 1; n < (constants.width + 1); n++)
					{
						var newColumn = null;
						if(n % 2 == 1)
						{
							newColumn = oddColumnTemplate.clone();
						}
						else
						{
							newColumn = evenColumnTemplate.clone();
							spacerType = (n / 2) + 1;
						}
						newColumn.find('.spacer').addClass('type-' + spacerType);
						newColumn.attr('data-column', n - 1);
						board.append(newColumn);
					}
				}
				
				function processGameOver()
				{
					$('.board .tile').addClass("burnt");
					//alert("You lose!");
					window.app.grayOut();
					var popup = window.app.container.children('.popup');
					popup.removeClass("game-over level-up");
					popup.addClass("game-over");
					popup.show();
					window.app.menu.screen.find('.button.resume-game').hide();
				}
				
				function createTile(letter)
				{
					var newTile = tileTemplate.clone();
					newTile.attr('data-letter', letter.letter);
					newTile.attr('data-points', letter.points);
					newTile.attr('data-multiplier', 1);
					newTile.find('.letter').html(letter.letter);
					newTile.find('.point-indicator').addClass('type-' + parseInt(letter.points / 3));
					return newTile;
				}
				
				function updateColumns()
				{
					var gameOver = false;
					$('.board .tile.flame').each(function()
					{
						var tile = $(this);
						var row = parseInt(tile.attr('data-row'));
						var column = parseInt(tile.attr('data-column'));
						if (row == (constants.height - 1 + column % 2))
						{
							gameOver = true;
						}
					});
					
					$('.board .column').each(function()
					{
						var column = $(this);
						
						column.find('.tile.burning').each(function()
						{
							var tile = $(this);
							var previousTile = tile.prev();
							if (previousTile.length > 0 && previousTile.hasClass("flame"))
							{
								tile.remove();
							}
							else
							{
								tile.removeClass("burning");
							}
						});
						
						var columnId = column.attr('data-column');
						var tileCount = column.find('.tile').length;
						
						var targetCount = constants.height;
						if (column.hasClass('even'))
						{
							targetCount++;
						}
						for(var i = 0; i < targetCount - tileCount; i++)
						{
							var letter = randomLetter();
							var newTile = createTile(letter);
							if (Math.random() < flameChance)
							{
								newTile.addClass("flame");
							}
							column.prepend(newTile);
						}
						
						tileCount = 0;
						column.find('.tile').each(function()
						{
							var tile = $(this);
							tile.attr('data-row', tileCount);
							tile.attr('data-column', columnId);
							if (tile.hasClass("flame"))
							{	var nextTile = tile.next();
								if (!nextTile.hasClass("flame"))
								{
									nextTile.addClass('burning');
								}
							}
							tileCount++;
						});
					});
					
					if (gameOver)
					{
						processGameOver();
					}
				}
				
				function fillDictionary(entries, kana)
				{
					$('.sidebar .dictionary').scrollTop(0);
					$('.sidebar .dictionary').html("");
					$('.sidebar .dictionary').append('<div class="item heading">' + kana + '</div>');
					var groupedEntries = [];
					var groupedEntriesIndex = {};
					for (var i = 0; i < entries.length; i++)
					{
						var entry = entries[i];
						var split = entry[0].split("/");
						var kanjiKana = split.shift();
						var kanji = kanjiKana.replace(/^(.*?)[\s ].*$/, "$1").trim();
						var entryKana = kanjiKana.replace(/^.*\[(.*)\].*$/, "$1").trim();
						var frequency = wordFrequency.findFrequency(kanji);
						var definition = split.join("; ").trim();
						var groupedEntry = null;
						var key = entryKana + " " + definition;
						if (typeof groupedEntriesIndex[key] == "undefined")
						{
							groupedEntry = {
								kana: entryKana,
								definition: definition,
								frequency: frequency,
								inflection: entry[1],
								entries: []
							};
							
							groupedEntriesIndex[key] = groupedEntry;
							groupedEntries.push(groupedEntry);
						}
						else
						{
							groupedEntry = groupedEntriesIndex[key];
						}
						var detailedEntry = {
							kanji: kanji,
							frequency: frequency
						};
						groupedEntry.entries.push(detailedEntry);
						if (frequency < groupedEntry.frequency)
						{
							groupedEntry.frequency = frequency;
						}
					}
					groupedEntries.sort(function(a,b){ return a.frequency - b.frequency; });
					for (var n = 0; n < groupedEntries.length; n++)
					{
						var groupedEntry = groupedEntries[n];
						groupedEntry.entries.sort(function(a,b){ return a.frequency - b.frequency; });
						var kanji = "";
						var firstKanji = true;
						for(var j = 0; j < groupedEntry.entries.length; j++)
						{
							var detailedEntry = groupedEntry.entries[j];
							if (firstKanji)
							{
								firstKanji = false;
							}
							else
							{
								kanji += ", ";
							}
							
							kanji += detailedEntry.kanji;
						}
						$('.sidebar .dictionary').append
						(
							'<div class="item">'
							+ '<div class="kanji">'
							+ kanji
							+ (kanji.indexOf(groupedEntry.kana) == -1 ? " [" + groupedEntry.kana + "]" : "")
							+ '</div>'
							+ (groupedEntry.inflection != null ? '<div class="inflection">' + groupedEntry.inflection + '</div>' : "")
							+ '<div class="translation">' + groupedEntry.definition + '</div>'
							+ '</div>'
						);
					}
				}
				
				function checkDictionary(letters, romaji, kana)
				{
					isValidWord = false;
					dictionaryEntries = null;
					updatePoints("");
					$('.sidebar .submit').removeClass("highlight");
					if (letters.length >= constants.minLength && !(/[a-z]/i).test(kana))
					{
						var search = rikaikun.wordSearch(kana, false, 15);
						if (search != null && search.data.length > 0)
						{
							isValidWord = true;
							dictionaryEntries = search.data;
						}
					}
					if (isValidWord)
					{
						$(lastLetter()).addClass('valid');
						$('.sidebar .submit').addClass("highlight");
						var _points = 0;
						var multiplier = 0;
						for(var i = 0; i < letters.length; i++)
						{
							var letter = $(letters[i]);
							_points += parseInt(letter.attr('data-points'));
							multiplier += parseInt(letter.attr('data-multiplier'));
						}
						_points += level;
						_points = _points * 10 * multiplier;
						points = _points;
						updatePoints(points);
					}
				}
				
				function wordToKana(word)
				{
					var value = "";
					for(var i = 0; i < word.length; i++)
					{
						var letter = $(word[i]);
						value += letter.attr('data-letter');
					}
					return ToKana.fromRomaji(value);
				}
				
				function updateWord()
				{
					var value = "";
					var _word = word;
					var kana = "";
					kana = wordToKana(_word);
					if (kana.length == 0)
					{
						$('.sidebar .level-indicator').show();
					}
					else
					{
						$('.sidebar .level-indicator').hide();
					}
					$('.sidebar .word-container .word').html(kana);
					checkDictionary(_word, value, kana);
				}
				
				function updatePoints(points)
				{
					$('.sidebar .word-container .points').text(points);
				}
				
				function removeArrow(letter)
				{
					$(letter).find('.arrow').remove();
				}
				
				function deselect(word)
				{
					for(var i = 0; i < word.length; i++)
					{
						var letter = word[i];
						$(letter).removeClass('selected');
						$(letter).removeClass('valid');
						removeArrow(letter);
					}
				}
				
				function shuffle()
				{
					flameChance = 0;
					var shuffleFlameChance = (19 + level) / Math.pow(10, 2);
					var _word = word;
					deselect(_word.splice(0, _word.length));
					updateWord();
					$('.board .tile:not(.flame):not(.burning)').each(function()
					{
						var oldTile = $(this);
						var letter = randomLetter();
						var newTile = createTile(letter);
						newTile.attr("data-row", oldTile.attr("data-row"));
						newTile.attr("data-column", oldTile.attr("data-column"));
						if (newTile.attr("data-row") == 0 && Math.random() < shuffleFlameChance)
						{
							newTile.addClass("flame");
						}
						oldTile.replaceWith(newTile);
					});
					updateColumns();
				}
				
				function computeFlameChance(word)
				{
					var _level = level;
					flameChance = (19 + _level) / Math.pow(10, word.length - 1);
					if (flameChance > 1)
					{
						flameChance = 1;
					}
					if (flameChance < 0)
					{
						flameChance = 0;
					}
				}
				
				function confirm()
				{
					if (!isValidWord)
					{
						return;
					}
					var _word = word;
					var kana = wordToKana(_word);
					fillDictionary(dictionaryEntries, kana);
					score += points;
					updateScore(score);
					computeFlameChance(_word);
					for(var i = 0; i < _word.length; i++)
					{
						$(_word[i]).remove();
					}
					_word.splice(0, _word.length);
					updateColumns();
					updateWord();
				}
				
				function updateScore(points)
				{
					$('.sidebar .score').html(points.toLocaleString('en-US'));
					var levelUp = points > nextLevel;
					if (levelUp)
					{
						level++;
						lastLevel = nextLevel;
						nextLevel = nextLevel + 3000 + (level - 1) * 1000;
						$('.sidebar .progress .bar').css('right', '0');
						$('.sidebar .progress .bar').css('right', '100%');
					}
					$('.sidebar .level-indicator .level').html(level);
					$('.sidebar .progress .bar').css('right', (100 - (100 * (points - lastLevel) / (nextLevel - lastLevel))) + '%');
				}
				
				function tileHandler()
				{
					var self = this;
					var tile = $(this);
					var _lastLetter = $(lastLetter());
					var _word = word;
					if (tile.hasClass('selected'))
					{
						if (self == _lastLetter[0])
						{
							if (isValidWord)
							{
								confirm();
							}
							else
							{
								deselect(_word.splice(_word.length - 1, 1));
							}
						}
						else
						{
							var index = $.inArray(self, _word) + 1;
							deselect(_word.splice(index, _word.length - index));
						}
						if (_word.length > 0)
						{
							removeArrow(lastLetter());
						}
					}
					else
					{
						if(typeof _lastLetter != "undefined")
						{
							var lastColumn = parseInt(_lastLetter.attr('data-column'));
							var lastRow = parseInt(_lastLetter.attr('data-row'));
							var currentColumn = parseInt(tile.attr('data-column'));
							var currentRow = parseInt(tile.attr('data-row'));
							if
							(
								Math.abs(currentColumn - lastColumn) > 1
								||
								(
									Math.abs(currentColumn - lastColumn) == 1
									&&
									(
										currentColumn % 2 == 0
										&& 
										(
											currentRow > lastRow
											|| currentRow - lastRow < -1
										)
										||
										currentColumn % 2 == 1
										&& 
										(
											currentRow < lastRow
											|| currentRow - lastRow > 1
										)
									)
								)
								||
								(
									currentColumn == lastColumn
									&& Math.abs(currentRow - lastRow) != 1
								)
							)
							{
								deselect(_word.splice(0, _word.length));
							}
						}
						if (_word.length > 0)
						{
							var arrowClass = ""
							_lastLetter = $(lastLetter());
							var lastLetterOffset = _lastLetter.offset();
							var tileOffset = tile.offset();
							if (tileOffset.top > lastLetterOffset.top)
							{
								arrowClass = "down";
							}
							else
							{
								arrowClass = "up";
							}
							if (tileOffset.left > lastLetterOffset.left)
							{
								arrowClass += "-right"
							}
							else if (tileOffset.left < lastLetterOffset.left)
							{
								arrowClass += "-left"
							}
							var newArrow = arrowTemplate.clone();
							newArrow.addClass(arrowClass);
							_lastLetter.append(newArrow);
						}
						_word.push(self);
						tile.addClass('selected');
					}
					updateWord();
				}
				
				function clearBoard()
				{
					$('.game .board .tile').remove();
				}
				
				window.newGame = function()
				{
					word = [];
					dictionaryEntries = null;
					score = 0;
					points = 0;
					level = 1;
					nextLevel = 3000;
					lastLevel = 0;
					flameChance = 0;
					clearBoard();
					updateColumns();
					updateWord();
					updateScore(score);
					//emptyDictionary
					$('.dictionary').html("");
				}
				
				//function init()
				window.init = function()
				{
					preloadStyleImages.preload();
					createColumns();
					$('.board').on('click', '.tile', tileHandler);
					$('.sidebar').on('click', '.submit', confirm);
					$('.sidebar').on('click', '.shuffle', shuffle);
					$('.sidebar').on('click', '.menu', function()
					{
						app.switchScreen("menu");
					});
					window.app.container.children('.popup').find('.actions .button').click(function()
					{
						var action = $(this);
						window.app.grayIn();
						action.closest('.popup').hide();
						if (action.hasClass("menu"))
						{
							app.switchScreen("menu");
						}
					});
					/*newGame();*/
				}
				
			});
		</script>
	</body>
</html>