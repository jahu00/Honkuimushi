<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<script type="text/javascript" src="jquery-1.8.2.min.js"></script>
		<script type="text/javascript" src="letters.js"></script>
		<script type="text/javascript" src="toKana.js"></script>
		<script type="text/javascript" src="js/fileHelpers.js"></script>
		<script type="text/javascript" src="js/preloadStyleImages.js"></script>
		<script type="text/javascript" src="rikaikun/data.js"></script>
		<link type="text/css" rel="stylesheet" media="screen" href="style.css">
		<link type="text/css" rel="stylesheet" media="screen" href="fonts/montserrat/montserrat.css">
		<link type="text/css" rel="stylesheet" media="screen" href="fonts/bokutachi-no-gothic-2/bokutachi-no-gothic-2.css">
		<link type="text/css" rel="stylesheet" media="screen" href="fonts/sigmar-one/sigmar-one.css">
	</head>
	<body>
		<div class="templates" style="display:none">
			<div class="tile unselectable">
				<div class="letter"></div>
				<div class="point-indicator"></div>
			</div>
			<div class="column odd"><div class="spacer"></div></div>
			<div class="column even"></div>
			<div class="arrow"></div>
		</div>
		<div id="Container">
		<div class="game screen">
			<div class="sidebar">
				<div class="word-container">
					<div class="score">0</div>
					<div class="word"></div>
					<div class="points"></div>
				</div>
				<div class="dictionary">
				</div>
			</div>
			<div class="board">
			</div>
		</div>
		<script>
			var rikaikun = new rcxDict(false);
			
			var constants = {
				width: 7,
				height: 7
			}
			
			var word = [];
			var dictionaryEntries = null;
			var score = 0;
			var points = 0;
			var level = 1;
			
			function lastLetter()
			{
				return word[word.length - 1];
			}			
			
			var isValidWord = false;
			
			function randomLetter()
			{
				var rand = Math.random();
				var base = 0;
				var letter = null;
				for (var i = 0, _letters = letters; i < _letters.length; i++)
				{
					letter = _letters[i];
					base += letter.probability;
					if (rand < base)
					{
						break;
					}
				}
				return letter;
			}
			
			$(function()
			{
				var tileTemplate = $('.templates .tile');
				var oddColumnTemplate = $('.templates .column.odd');
				var evenColumnTemplate = $('.templates .column.even');
				var arrowTemplate = $('.templates .arrow');
				
				function createColumns()
				{
					var board = $('.board');
					var spacerType = 1;
					for(var n = 1; n < (constants.width + 1); n++)
					{
						var newColumn = null;
						if(n % 2 == 1)
						{
							newColumn = oddColumnTemplate.clone();
						}
						else
						{
							newColumn = evenColumnTemplate.clone();
							spacerType = (n / 2) + 1;
						}
						newColumn.find('.spacer').addClass('type-' + spacerType);
						newColumn.attr('data-column', n);
						board.append(newColumn);
					}
				}
				
				function updateColumns()
				{
					$('.board .column').each(function()
					{
						var column = $(this);
						var columnId = column.attr('data-column');
						var tileCount = column.find('.tile').length;
						
						var targetCount = constants.height;
						if (column.hasClass('even'))
						{
							targetCount++;
						}
						for(var i = 0; i < targetCount - tileCount; i++)
						{
							var newTile = tileTemplate.clone();
							var letter = randomLetter();
							newTile.attr('data-letter', letter.letter);
							newTile.attr('data-points', letter.points);
							newTile.attr('data-multiplier', 1);
							newTile.find('.letter').html(letter.letter);
							newTile.find('.point-indicator').addClass('type-' + parseInt(letter.points / 3));
							column.prepend(newTile);
						}
						
						tileCount = 0;
						column.find('.tile').each(function()
						{
							var tile = $(this);
							tile.attr('data-row', tileCount);
							tile.attr('data-column', columnId);
							tileCount++;
						});
					});
				}
				
				function fillDictionary(entries)
				{
					$('.sidebar .dictionary').html("");
					for (var i = 0; i < entries.length; i++)
					{
						var entry = entries[i];
						$('.sidebar .dictionary').append('<div class="item">' + entry[0] + (entry[1] != null ? '<br/>' + entry[1] : '') + '</div>');
					}
				}
				
				function checkDictionary(letters, romaji, kana)
				{
					isValidWord = false;
					dictionaryEntries = null;
					updatePoints("");
					if (letters.length > 2 && !(/[a-z]/i).test(kana))
					{
						var search = rikaikun.wordSearch(kana, false, 15);
						if (search != null && search.data.length > 0)
						{
							isValidWord = true;
							dictionaryEntries = search.data;
						}
					}
					if (isValidWord)
					{
						$(lastLetter()).addClass('valid');
						var _points = 0;
						var multiplier = 0;
						for(var i = 0; i < letters.length; i++)
						{
							var letter = $(letters[i]);
							_points += parseInt(letter.attr('data-points'));
							multiplier += parseInt(letter.attr('data-multiplier'));
						}
						_points += level;
						_points = _points * 10 * multiplier;
						points = _points;
						updatePoints(points);
					}
				}
				
				function updateWord()
				{
					var value = "";
					var _word = word;
					for(var i = 0; i < _word.length; i++)
					{
						var letter = $(_word[i]);
						value += letter.attr('data-letter');
					}
					var kana = ToKana.fromRomaji(value);
					$('.sidebar .word-container .word').html(kana);
					checkDictionary(_word, value, kana);
				}
				
				function updatePoints(points)
				{
					$('.sidebar .word-container .points').text(points);
				}
				
				function removeArrow(letter)
				{
					$(letter).find('.arrow').remove();
				}
				
				function deselect(word)
				{
					for(var i = 0; i < word.length; i++)
					{
						var letter = word[i];
						$(letter).removeClass('selected');
						$(letter).removeClass('valid');
						removeArrow(letter);
					}
				}
				
				function confirm()
				{
					fillDictionary(dictionaryEntries);
					score += points;
					updateScore(score);
					var _word = word;
					for(var i = 0; i < _word.length; i++)
					{
						$(_word[i]).remove();
					}
					_word.splice(0, _word.length);
					updateColumns();
				}
				
				function updateScore(points)
				{
					$('.sidebar .word-container .score').html(points);
				}
				
				$('.board').on('click', '.tile', function()
				{
					var self = this;
					var tile = $(this);
					var _lastLetter = $(lastLetter());
					var _word = word;
					if (tile.hasClass('selected'))
					{
						if (self == _lastLetter[0])
						{
							if (isValidWord)
							{
								confirm();
							}
							else
							{
								//tile.removeClass('selected');
								deselect(_word.splice(_word.length - 1, 1));
							}
						}
						else
						{
							var index = $.inArray(self, _word) + 1;
							deselect(_word.splice(index, _word.length - index));
						}
						if (_word.length > 0)
						{
							removeArrow(lastLetter());
						}
					}
					else
					{
						if(typeof _lastLetter != "undefined")
						{
							var lastColumn = parseInt(_lastLetter.attr('data-column'));
							var lastRow = parseInt(_lastLetter.attr('data-row'));
							var currentColumn = parseInt(tile.attr('data-column'));
							var currentRow = parseInt(tile.attr('data-row'));
							if
							(
								Math.abs(currentColumn - lastColumn) > 1
								||
								(
									Math.abs(currentColumn - lastColumn) == 1
									&&
									(
										currentColumn % 2 == 1
										&& 
										(
											currentRow > lastRow
											|| currentRow - lastRow < -1
										)
										||
										currentColumn % 2 == 0
										&& 
										(
											currentRow < lastRow
											|| currentRow - lastRow > 1
										)
									)
								)
								||
								(
									currentColumn == lastColumn
									&& Math.abs(currentRow - lastRow) != 1
								)
							)
							{
								deselect(_word.splice(0, _word.length));
							}
						}
						if (_word.length > 0)
						{
							var arrowClass = ""
							_lastLetter = $(lastLetter());
							var lastLetterOffset = _lastLetter.offset();
							var tileOffset = tile.offset();
							if (tileOffset.top > lastLetterOffset.top)
							{
								arrowClass = "down";
							}
							else
							{
								arrowClass = "up";
							}
							if (tileOffset.left > lastLetterOffset.left)
							{
								arrowClass += "-right"
							}
							else if (tileOffset.left < lastLetterOffset.left)
							{
								arrowClass += "-left"
							}
							var newArrow = arrowTemplate.clone();
							newArrow.addClass(arrowClass);
							_lastLetter.append(newArrow);
						}
						_word.push(self);
						tile.addClass('selected');
					}
					updateWord();
				});
				
				function init()
				{
					preloadStyleImages.preload();
					createColumns();
					updateColumns();
				}
				
				init();
			});
		</script>
	</body>
</html>